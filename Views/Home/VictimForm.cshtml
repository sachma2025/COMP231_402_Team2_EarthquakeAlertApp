@{
    ViewData["Title"] = "Victim Report";
    Layout = null;
    var userName = Context.Session.GetString("UserName") ?? "Unknown User";
}

<!DOCTYPE html>
<html>
<head>
    <title>Victim Report</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/css/VictimForm.css" />

    <style>
        #map {
            height: 250px;
            width: 100%;
            margin-top: 15px;
            border: 2px solid #ccc;
            border-radius: 10px;
        }

        .loading {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <h2>Victim Report</h2>

    <p id="locationStatus" class="loading">Detecting your location…</p>

    <div class="form-wrapper">
    <form id="victimForm" enctype="multipart/form-data">

        <label>Name:</label>
        <input type="text" id="name" value="@userName"
                   @(userName != "Unknown User" ? "readonly style='background:#eee'" : "")
                   placeholder="Enter your name if not signed in">

        <label>Injury Level:</label>
        <select id="injury">
            <option value="Minor">Minor</option>
            <option value="Moderate">Moderate</option>
            <option value="Severe">Severe</option>
            <option value="Critical">Critical</option>
        </select>

        <label>Description:</label>
        <textarea id="description"></textarea>

        <label>Take / Upload Photo:</label><br>
        <input type="file" id="photo" accept="image/*" capture="camera" />
        <img id="previewImg" />

        <div id="map"></div>
            


        <button type="button" id="submitBtn" disabled onclick="submitVictim()">
            Submit Report
        </button>

        <p id="status"></p>
    </form>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let userLat = null;
        let userLng = null;
        let map, marker;

        // Disable submit first
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;

        // Handle Photo Preview
        document.getElementById("photo").addEventListener("change", function () {
            const file = this.files[0];
            const preview = document.getElementById("previewImg");

            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                };
                reader.readAsDataURL(file);
            }
        });

        // Auto Location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;

                    document.getElementById("locationStatus").textContent =
                        "Location detected ✓";

                    document.getElementById("submitBtn").disabled = false;

                    map = L.map('map').setView([userLat, userLng], 16);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
                        .addTo(map);

                    marker = L.marker([userLat, userLng], { draggable: true }).addTo(map)
                        .bindPopup("Drag to adjust location").openPopup();

                    marker.on("dragend", function (e) {
                        const pos = marker.getLatLng();
                        userLat = pos.lat;
                        userLng = pos.lng;
                    });
                },

                err => {
                    document.getElementById("locationStatus").textContent =
                        "Enable location services to submit this form.";
                },

                { enableHighAccuracy: true }
            );
        }

        // Submit Form
        async function submitVictim() {
            const status = document.getElementById("status");
            status.textContent = "Submitting…";

            const formData = new FormData();
            formData.append("Name", document.getElementById("name").value);
            formData.append("injuryLevel", document.getElementById("injury").value);
            formData.append("description", document.getElementById("description").value);
            formData.append("latitude", userLat);
            formData.append("longitude", userLng);
            

            const file = document.getElementById("photo").files[0];
            if (file) {
                formData.append("Photo", file);
            }

            // --- Reverse geocode to get address ---
            try {            
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLng}`);           
                const data = await response.json();
                formData.append("Address", data.display_name || "Unknown location");
            } catch (err) {
                console.error("Error fetching address:", err); 
                formData.append("Address", "Unknown location"); 
            }

            const res = await fetch("/Home/VictimForm", {
                method: "POST",
                body: formData
            });

            if (res.ok) {
                status.textContent = "Report sent!";
            } else {
                status.textContent = "Error submitting report.";
            }
        }
    </script>

</body>
</html>
