@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>First Responder Dashboard</title>
    <link rel="stylesheet" href="~/css/firstRespDashboard.css" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
    <header class="navbar">
        <div class="navbar-left">
            <img src="https://cdn-icons-png.flaticon.com/512/564/564619.png" alt="Logo" class="logo">
            <div class="app-info">
                <h1>Earthquake Disaster App</h1>
                <p>First Responder Account: FR-2847</p>
            </div>
        </div>
        <form asp-controller="Home" asp-action="Logout" method="post">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </header>

    <main class="main-content">
        <section class="left-panel">
            <!-- Map Section -->
            <div class="map-card">
                <h2>Affected Areas</h2>
                <div class="map-container">
                    <div id="map" style="width:100%; height:400px; border-radius:10px;"></div>
                </div>
            </div>

            <!-- Real-time Updates -->
            <div class="updates-card">
                <div class="updates-header">
                    <h2>Real-time Updates</h2>
                    <span class="badge live">Live</span>
                </div>
                <ul class="updates-list" style="max-height: 300px; overflow-y: auto;">
                    <li class="update-item red">
                        <span>Downtown Vancouver affected - Structural damage reported</span>
                        <span class="time">2 min ago</span>
                    </li>
                    <li class="update-item yellow">
                        <span>150 estimated injuries</span>
                        <span class="time">5 min ago</span>
                    </li>
                    <li class="update-item yellow">
                        <span>Kitsilano affected - Gas leak detected on 4th Avenue</span>
                        <span class="time">8 min ago</span>
                    </li>
                    <li class="update-item red">
                        <span>3 buildings collapsed in Gastown area</span>
                        <span class="time">12 min ago</span>
                    </li>
                    <li class="update-item blue">
                        <span>Yaletown affected - Power outage in progress</span>
                        <span class="time">15 min ago</span>
                    </li>
                    <li class="update-item yellow">
                        <span>75 estimated injuries in Chinatown district</span>
                        <span class="time">18 min ago</span>
                    </li>
                </ul>
            </div>
        </section>

        <!-- Quick Actions Panel -->
        <aside class="right-panel">
            <h2>Quick Actions</h2>
            <button class="action-btn report">Report Incident</button>
            <button class="action-btn resources" onclick="window.location.href='/Home/Resources'">Request Resources</button>
            <button class="action-btn emergency" onclick="window.location.href='/Home/DistressAlerts'">Emergency Alerts</button>
        </aside>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        window.addEventListener("load", () => {


            const map = L.map('map').setView([49.2827, -123.1207], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const presetIncidents = [
                { lat: 49.283, lng: -123.115, title: "Downtown Incident" },
                { lat: 49.263, lng: -123.138, title: "Kitsilano Damage" },
                { lat: 49.270, lng: -123.100, title: "Gastown Collapse" }
            ];

            presetIncidents.forEach(i => {
                L.marker([i.lat, i.lng]).addTo(map).bindPopup(i.title);
            });

                function randomVancouverCoordinate() {
            const lat = 49.24 + Math.random() * 0.08;
            const lng = -123.18 + Math.random() * 0.12;
            return { lat, lng };
        }

        let frLocation = randomVancouverCoordinate();

        let frMarker = L.marker([frLocation.lat, frLocation.lng], {
            icon: L.icon({
                iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup("First Responder Location");

        map.setView([frLocation.lat, frLocation.lng], 13);


            let lastColor = null;

            function addRandomUpdate() {
                const responses = [
                    "Aftershock detected near downtown area.",
                    "Emergency crews dispatched to collapsed building.",
                    "Gas leak reported in East Vancouver.",
                    "Bridge inspection underway after tremor.",
                    "Power outage reported in Kitsilano district."
                ];

                const colors = ["red", "yellow", "blue"];
                const message = responses[Math.floor(Math.random() * responses.length)];
                const time = new Date().toLocaleTimeString();

                let color;
                do { color = colors[Math.floor(Math.random() * colors.length)]; }
                while (color === lastColor);
                lastColor = color;

                const list = document.querySelector(".updates-list");
                const li = document.createElement("li");
                li.className = `update-item ${color}`;
                li.innerHTML = `<span>${message}</span><span class="time">${time}</span>`;
                list.prepend(li);
            }

            const displayedVictims = new Set();
            const victimMarkerGroup = L.layerGroup().addTo(map);

            function injuryColor(level) {
                switch (level) {
                    case "Minor": return "green";
                    case "Moderate": return "yellow";
                    case "Severe": return "orange";
                    case "Critical": return "red";
                    default: return "blue";
                }
            }

            function fetchVictims() {
                fetch('/Victim/GetVictims')
                    .then(res => res.json())
                    .then(victims => {
                        victims.forEach(v => {

                            if (!displayedVictims.has(v.name)) {
                                displayedVictims.add(v.name);

                                const list = document.querySelector(".updates-list");
                                const li = document.createElement("li");
                                li.className = `update-item ${injuryColor(v.injuryLevel)}`;
                                li.innerHTML =
                                    `<span>Victim: ${v.name} — ${v.injuryLevel}</span>
                                     <span class="time">Just now</span>`;
                                list.prepend(li);

                                const coords = v.location.split(",");
                                const lat = parseFloat(coords[0]);
                                const lng = parseFloat(coords[1]);

                                const marker = L.circleMarker([lat, lng], {
                                    radius: 10,
                                    color: injuryColor(v.injuryLevel),
                                    fillColor: injuryColor(v.injuryLevel),
                                    fillOpacity: 0.9
                                }).addTo(victimMarkerGroup);

                                marker.bindPopup(`
                                    <strong>${v.name}</strong><br>
                                    Injury: ${v.injuryLevel}<br>
                                    Location: ${v.location}<br>
                                    Notes: ${v.notes}
                                `);
                            }
                        });
                    });
            }

                    const dynamicMarkers = [];
        let colorIndex = 0;
        const cycleColors = ["red", "yellow", "blue"];

        function nextColor() {
            const color = cycleColors[colorIndex];
            colorIndex = (colorIndex + 1) % cycleColors.length;
            return color;
        }

                function addIncidentMarker(lat, lng, message) {

            const googleMapsUrl =
                `https://www.google.com/maps/dir/?api=1&origin=${frLocation.lat},${frLocation.lng}` +
                `&destination=${lat},${lng}`;

            const popupHtml = `
                <strong>${message}</strong><br><br>
                <a href="${googleMapsUrl}" target="_blank" style="color:blue; text-decoration:underline;">
                    Get Directions
                </a>
            `;

            var marker = L.marker([lat, lng]).addTo(map)
                .bindPopup(popupHtml);

            dynamicMarkers.push(marker);
        }


        function appendDynamicUpdate(message, time) {
            const list = document.querySelector(".updates-list");
            const li = document.createElement("li");

            li.className = `update-item ${nextColor()}`;

            li.innerHTML = `
                <span>${message}</span>
                <span class="time">${time}</span>
            `;

            list.prepend(li);
        }

        async function fetchUpdate() {
            try {
                const response = await fetch("/Home/GetNewMessage");
                const data = await response.json();

                appendDynamicUpdate(data.message, data.time);
                addIncidentMarker(data.lat, data.lng, data.message);

            } catch (err) {
                console.log("Error fetching dynamic update:", err);
            }
        }

            //setInterval(addRandomUpdate, 10000);  // simulated message updates
            setInterval(fetchVictims, 15000);     // victim updates
            setInterval(fetchUpdate, 10000);      // REAL dynamic incidents from server
        });
    </script>

</body>
</html>
